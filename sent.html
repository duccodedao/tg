<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ứng dụng gửi giao dịch TON</title>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 480px;
      margin: auto;
    }
    h1 {
      text-align: center;
    }
    #ton-connect {
      margin-bottom: 20px;
    }
    button {
      padding: 12px 20px;
      margin: 5px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      transition: background-color 0.3s ease;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      color: #666666;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>

  <h1>Ứng dụng gửi giao dịch TON</h1>

  <!-- Nút kết nối ví sẽ được gắn vào đây -->
  <div id="ton-connect"></div>

  <button id="sendBtn" disabled>Gửi 0.01 TON</button>
  <button id="sendWithCommentBtn" disabled>Gửi 0.01 TON kèm comment</button>

  <p id="status">Chưa kết nối</p>

  <script>
    // Khởi tạo TonConnectUI
    const tonConnectUI = new TonConnectUI.TonConnectUI({
      manifestUrl: 'https://bmweb.site/tonconnect-manifest.json',
      buttonRootId: 'ton-connect'
    });

    // Cập nhật trạng thái kết nối ví
    tonConnectUI.onStatusChange(wallet => {
      const statusElem = document.getElementById('status');
      const sendBtn = document.getElementById('sendBtn');
      const sendWithCommentBtn = document.getElementById('sendWithCommentBtn');

      if (wallet) {
        statusElem.textContent = 'Đã kết nối: ' + wallet.account.address;
        sendBtn.disabled = false;
        sendWithCommentBtn.disabled = false;
      } else {
        statusElem.textContent = 'Chưa kết nối';
        sendBtn.disabled = true;
        sendWithCommentBtn.disabled = true;
      }
    });

    // Địa chỉ ví nhận tiền
    const recipientAddress = "UQDu8vyZSZbAYvRRQ_jW4_0EiBGibAGq72wSZjYWRmNAGhRD";

    // Nút gửi 0.01 TON (không có comment)
    document.getElementById('sendBtn').addEventListener('click', async () => {
      const transaction = {
        validUntil: Math.floor(Date.now() / 1000) + 60,
        messages: [
          {
            address: recipientAddress,
            amount: "10000000" // 0.01 TON = 10,000,000 nanotons
          }
        ]
      };

      try {
        const result = await tonConnectUI.sendTransaction(transaction);
        alert('Giao dịch đã gửi thành công! Tx boc: ' + result.boc);
        console.log('Giao dịch thành công:', result);
      } catch (error) {
        alert('Lỗi khi gửi giao dịch: ' + error.message);
        console.error('Lỗi gửi giao dịch:', error);
      }
    });

    // Nút gửi 0.01 TON kèm comment (text)
    document.getElementById('sendWithCommentBtn').addEventListener('click', async () => {
      const comment = "Xin chào từ DApp của tôi!";

      // Mã hóa comment thành Uint8Array (payload bytes)
      const encoder = new TextEncoder();
      const commentBytes = encoder.encode(comment);

      // Opcode 0x00000000 (4 byte 0) + comment bytes
      const payloadBytes = new Uint8Array(4 + commentBytes.length);
      payloadBytes.set([0, 0, 0, 0], 0);
      payloadBytes.set(commentBytes, 4);

      // Chuyển payload sang chuỗi hex
      const payloadHex = Array.from(payloadBytes)
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');

      const transaction = {
        validUntil: Math.floor(Date.now() / 1000) + 60,
        messages: [
          {
            address: recipientAddress,
            amount: "10000000",
            payload: payloadHex
          }
        ]
      };

      try {
        const result = await tonConnectUI.sendTransaction(transaction);
        alert('Giao dịch kèm comment đã gửi thành công! Tx boc: ' + result.boc);
        console.log('Giao dịch kèm comment thành công:', result);
      } catch (error) {
        alert('Lỗi khi gửi giao dịch kèm comment: ' + error.message);
        console.error('Lỗi gửi giao dịch kèm comment:', error);
      }
    });
  </script>
</body>
</html>
