<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Account Info & TonConnect</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
 
<style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Gi·ªØ n·ªôi dung cƒÉn tr√™n */
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
            max-width: 960px; /* Chi·ªÅu r·ªông t·ªëi ƒëa cho desktop */
            box-sizing: border-box;
            /* Th√™m transition cho hi·ªáu ·ª©ng ph√≥ng to ch·ªØ */
            transition: font-size 0.2s ease-in-out;
        }

        h1 {
            color: #4a4a4a;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px; /* 2em = 32px (gi·∫£ s·ª≠ base font-size l√† 16px) */
            font-weight: 700;
        }

        h2 {
            color: #4a4a4a;
            border-bottom: none;
            padding-bottom: 0;
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 25.6px; /* 1.6em = 25.6px */
            text-align: center;
            font-weight: 500;
        }

        .data-section,
        #wallet-info {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 15px;
            border: none;
            /* Th√™m transition cho padding v√† margin ƒë·ªÉ ƒëi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc m∆∞·ª£t m√† */
            transition: padding 0.2s ease, margin 0.2s ease;
        }

        .connect-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        #connect-wallet {
            /* Styles for the TonConnect button will be managed by the library itself */
            /* ƒê·∫£m b·∫£o n√∫t Connect TonConnectUI ƒë∆∞·ª£c cƒÉn gi·ªØa */
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            min-width: 180px; /* Th√™m min-width ƒë·ªÉ n√∫t kh√¥ng qu√° nh·ªè */
            height: 48px; /* Th√™m height */
            font-size: 17.6px; /* 1.1em = 17.6px */
        }

        #connect-wallet button {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 17.6px; /* 1.1em = 17.6px */
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            display: flex; /* ƒê·ªÉ icon v√† text cƒÉn ch·ªânh */
            align-items: center;
            gap: 8px; /* Kho·∫£ng c√°ch gi·ªØa icon v√† text */
        }

        #connect-wallet button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap; /* Cho ph√©p c√°c n√∫t xu·ªëng d√≤ng tr√™n m√†n h√¨nh nh·ªè */
        }

        .button-group button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px; /* 1em = 16px */
            transition: background-color 0.3s ease, transform 0.2s ease, font-size 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .button-group button:hover {
            transform: translateY(-2px);
        }

        #disconnect-wallet {
            background-color: #dc3545;
            color: white;
            display: none; /* Hidden by default */
        }

        #disconnect-wallet:hover {
            background-color: #c82333;
        }

        #fetch-data-btn {
            background-color: #28a745; /* M√†u xanh l√° c√¢y */
            color: white;
        }

        #fetch-data-btn:hover {
            background-color: #218838;
        }

        #toggle-text-size-btn {
            background-color: #ffc107; /* M√†u v√†ng */
            color: #333;
        }

        #toggle-text-size-btn:hover {
            background-color: #e0a800;
        }

        #wallet-info {
            background-color: #ffffff;
            border: none;
            padding: 20px;
            text-align: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-top: 0;
            display: none; /* Hidden by default */
        }

        #wallet-info p {
            margin: 8px 0;
            font-size: 15.2px; /* 0.95em = 15.2px */
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
        }
        #wallet-info p:last-child {
            border-bottom: none;
        }
        #wallet-info p strong {
            color: #333;
        }

        #account-address {
            font-weight: bold;
            color: #007bff;
            word-break: break-all;
            font-size: 14.4px; /* 0.9em = 14.4px */
            cursor: pointer; /* Cho ph√©p copy */
        }

        .data-item {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            font-size: 15.2px; /* 0.95em = 15.2px */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-item:last-child {
            border-bottom: none;
        }
        .data-item strong {
            min-width: 100px; /* ƒê·∫£m b·∫£o ti√™u ƒë·ªÅ kh√¥ng b·ªã co qu√° nhi·ªÅu */
            color: #555;
        }
        .data-item span {
            text-align: right;
            word-break: break-word;
            font-family: 'Roboto', sans-serif;
            color: #0056b3;
        }

        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }

        /* Jetton Section Styles - Desktop */
        .jetton-item {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 15px 20px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 50px 2fr 1.5fr; /* C·ªôt 1: ·∫£nh, C·ªôt 2: th√¥ng tin tr√°i, C·ªôt 3: th√¥ng tin ph·∫£i */
            gap: 15px;
            align-items: center;
            font-size: 15.2px; /* 0.95em = 15.2px */
            color: #555;
            border: none;
            transition: all 0.2s ease-in-out; /* Th√™m transition */
        }

        .jetton-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #eee;
            flex-shrink: 0;
            grid-column: 1;
            grid-row: 1 / span 2;
            align-self: center;
        }

        .jetton-info-left { /* C·ªôt 2: T√™n Jetton, Gi√° Jetton */
            grid-column: 2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding-left: 5px;
        }
        .jetton-info-left .jetton-name { /* T√™n Jetton (h√†ng 1) */
            font-size: 16px; /* 1em = 16px */
            color: #333;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .jetton-info-left .jetton-price { /* Gi√° Jetton (%24h) (h√†ng 2) */
            font-size: 13.6px; /* 0.85em = 13.6px */
            color: #666;
            white-space: nowrap; /* Gi·ªØ tr√™n m·ªôt d√≤ng n·∫øu c√≥ th·ªÉ */
        }

        .jetton-info-right { /* C·ªôt 3: S·ªë l∆∞·ª£ng Jetton, Gi√° tr·ªã */
            grid-column: 3;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
            padding-right: 5px;
        }
        .jetton-info-right .jetton-balance-amount { /* S·ªë l∆∞·ª£ng Jetton (h√†ng 1) */
            font-weight: bold;
            color: #333;
            font-size: 16px; /* 1em = 16px */
            margin-bottom: 2px;
        }
        .jetton-info-right .jetton-value-usd { /* Gi√° tr·ªã (h√†ng 2) */
            font-size: 13.6px; /* 0.85em = 13.6px */
            color: #666;
        }

        /* Event Section Styles - Desktop */
        #events-output {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 0;
        }

        .event-item {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 15px 20px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 50px 2.5fr 1.5fr;
            gap: 15px;
            align-items: start;
            font-size: 15.2px; /* 0.95em = 15.2px */
            color: #555;
            border: none;
            transition: all 0.2s ease-in-out; /* Th√™m transition */
        }


        .event-item .event-token-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #eee;
            flex-shrink: 0;
            grid-column: 1;
            grid-row: 1 / span 3; /* ·∫¢nh chi·∫øm 3 h√†ng */
            align-self: center;
            justify-self: center;
        }

        .event-details-left {
            grid-column: 2;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            font-size: 14.4px; /* 0.9em = 14.4px */
            padding-left: 5px;
        }
        .event-details-left .type-transaction {
            color: #333;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .event-details-left .from-to-addresses {
            color: #666;
            font-size: 13.6px; /* 0.85em = 13.6px */
            word-break: break-word;
            margin-bottom: 2px;
        }
        .event-details-left .comment-text {
            color: #666;
            font-size: 13.6px; /* 0.85em = 13.6px */
        }

        .event-details-right { /* C·ªôt 3: S·ªë l∆∞·ª£ng + Symbol, Th·ªùi gian, Completed üîó */
            grid-column: 3;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-end;
            text-align: right;
            font-size: 14.4px; /* 0.9em = 14.4px */
            padding-right: 5px;
        }
        .event-details-right .amount { /* S·ªë l∆∞·ª£ng + Symbol (h√†ng 1) */
            font-weight: bold;
            font-size: 16px; /* 1em = 16px */
            white-space: nowrap; /* Gi·ªØ tr√™n m·ªôt d√≤ng n·∫øu c√≥ th·ªÉ */
            margin-bottom: 2px;
        }
        .event-details-right .timestamp { /* Th·ªùi gian (h√†ng 2) */
            font-size: 13.6px; /* 0.85em = 13.6px */
            color: #666;
            white-space: nowrap; /* Gi·ªØ tr√™n m·ªôt d√≤ng n·∫øu c√≥ th·ªÉ */
            margin-bottom: 2px;
        }
        .event-details-right .status-link { /* Completed üîó (h√†ng 3) */
            font-size: 13.6px; /* 0.85em = 13.6px */
            color: #007bff;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .event-details-right .status-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .event-item.sent .amount {
            color: #d32f2f;
        }
        .event-item.received .amount {
            color: #4caf50;
        }

        /* Hidden address parse data */
        #address-parse-data {
            display: none;
        }

        /* Responsive adjustments for MOBILE DEVICES (Maintaining 3 columns) */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 0;
            }
            h1 {
                font-size: 20.8px; /* 1.3em = 20.8px */
                margin-bottom: 10px;
            }
            h2 {
                font-size: 17.6px; /* 1.1em = 17.6px */
                margin-top: 10px;
                margin-bottom: 8px;
            }

            .data-section,
            #wallet-info {
                padding: 8px;
                margin-bottom: 8px;
            }
            .data-item {
                font-size: 13.6px; /* 0.85em = 13.6px */
            }
            #wallet-info p {
                font-size: 13.6px; /* 0.85em = 13.6px */
            }
            #account-address {
                font-size: 12.8px; /* 0.8em = 12.8px */
            }

            .button-group {
                flex-direction: column;
                align-items: center;
                gap: 10px; /* Gi·∫£m kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
            }
            .button-group button {
                width: 100%;
                max-width: 200px; /* ƒê·∫∑t chi·ªÅu r·ªông t·ªëi ƒëa cho n√∫t */
                padding: 10px 15px; /* Gi·∫£m padding n√∫t */
                font-size: 14.4px; /* 0.9em = 14.4px */
            }


            /* JETTON ITEM STYLES FOR MOBILE - STILL 3 COLUMNS */
            .jetton-item {
                grid-template-columns: 30px 1.8fr 1.2fr;
                gap: 5px;
                font-size: 12px; /* 0.75em = 12px */
                padding: 8px; /* Gi·∫£m padding */
            }

            .jetton-item img {
                width: 26px;
                height: 26px;
            }

            .jetton-info-left {
                padding-left: 2px;
            }
            .jetton-info-left .jetton-name {
                font-size: 14.4px; /* 0.9em = 14.4px */
                white-space: normal;
            }
            .jetton-info-left .jetton-price {
                font-size: 11.2px; /* 0.7em = 11.2px */
                white-space: normal;
            }

            .jetton-info-right {
                padding-right: 2px;
            }
            .jetton-info-right .jetton-balance-amount {
                font-size: 14.4px; /* 0.9em = 14.4px */
                white-space: normal;
            }
            .jetton-info-right .jetton-value-usd {
                font-size: 11.2px; /* 0.7em = 11.2px */
                white-space: normal;
            }

            /* EVENT ITEM STYLES FOR MOBILE - STILL 3 COLUMNS */
            .event-item {
                grid-template-columns: 30px 1.8fr 1.2fr;
                gap: 5px;
                font-size: 12px; /* 0.75em = 12px */
                padding: 8px; /* Gi·∫£m padding */
            }

            .event-item .event-token-image {
                width: 26px;
                height: 26px;
            }

            .event-details-left {
                padding-left: 2px;
            }
            .event-details-left .type-transaction {
                font-size: 13.6px; /* 0.85em = 13.6px */
            }
            .event-details-left .from-to-addresses {
                font-size: 11.2px; /* 0.7em = 11.2px */
                word-break: break-word;
            }
            .event-details-left .comment-text {
                font-size: 10.4px; /* 0.65em = 10.4px */
            }

            .event-details-right {
                padding-right: 2px;
            }
            .event-details-right .amount {
                font-size: 13.6px; /* 0.85em = 13.6px */
                white-space: normal;
            }
            .event-details-right .timestamp {
                font-size: 11.2px; /* 0.7em = 11.2px */
                white-space: normal;
            }
            .event-details-right .status-link {
                font-size: 10.4px; /* 0.65em = 10.4px */
                white-space: normal;
            }
        }

        /* Extremely small screens (e.g., iPhone SE portrait) - May still be very cramped */
        @media (max-width: 420px) {
            .jetton-item {
                grid-template-columns: 25px 1.6fr 1.1fr;
                gap: 2px;
                font-size: 10.4px; /* 0.65em = 10.4px */
                padding: 4px;
            }
            .jetton-item img {
                width: 20px;
                height: 20px;
            }
            .jetton-info-left .jetton-name,
            .jetton-info-right .jetton-balance-amount {
                font-size: 12.8px; /* 0.8em = 12.8px */
            }
            .jetton-info-left .jetton-price,
            .jetton-info-right .jetton-value-usd {
                font-size: 9.6px; /* 0.6em = 9.6px */
            }

            .event-item {
                grid-template-columns: 25px 1.6fr 1.1fr;
                gap: 2px;
                font-size: 10.4px; /* 0.65em = 10.4px */
                padding: 4px;
            }
            .event-item .event-token-image {
                width: 20px;
                height: 20px;
            }
            .event-details-left .type-transaction,
            .event-details-right .amount {
                font-size: 12px; /* 0.75em = 12px */
            }
            .event-details-left .from-to-addresses,
            .event-details-right .timestamp {
                font-size: 9.6px; /* 0.6em = 9.6px */
            }
            .event-details-left .comment-text,
            .event-details-right .status-link {
                font-size: 8.8px; /* 0.55em = 8.8px */
            }
        }

        /* Larger text specific styles */
        .larger-text h1 { font-size: 35.2px; /* 2.2em = 35.2px */ }
        .larger-text h2 { font-size: 28.8px; /* 1.8em = 28.8px */ }
        .larger-text .data-section,
        .larger-text #wallet-info,
        .larger-text .jetton-item,
        .larger-text .event-item {
            padding: 22px; /* TƒÉng padding nh·∫π khi ch·ªØ l·ªõn h∆°n */
        }

        .larger-text #wallet-info p,
        .larger-text .data-item { font-size: 16.8px; /* 1.05em = 16.8px */ }
        .larger-text #account-address { font-size: 16px; /* 1em = 16px */ }
        .larger-text .button-group button { font-size: 16.8px; /* 1.05em = 16.8px */ }

        .larger-text .jetton-item { font-size: 16.8px; /* 1.05em = 16.8px */ }
        .larger-text .jetton-item img { width: 45px; height: 45px; }
        .larger-text .jetton-info-left .jetton-name,
        .larger-text .jetton-info-right .jetton-balance-amount { font-size: 17.6px; /* 1.1em = 17.6px */ }
        .larger-text .jetton-info-left .jetton-price,
        .larger-text .jetton-info-right .jetton-value-usd { font-size: 15.2px; /* 0.95em = 15.2px */ }

        .larger-text .event-item { font-size: 16.8px; /* 1.05em = 16.8px */ }
        .larger-text .event-item .event-token-image { width: 45px; height: 45px; }
        .larger-text .event-details-left .type-transaction,
        .larger-text .event-details-right .amount { font-size: 17.6px; /* 1.1em = 17.6px */ }
        .larger-text .event-details-left .from-to-addresses,
        .larger-text .larger-text .event-details-left .comment-text,
        .larger-text .event-details-right .timestamp,
        .larger-text .event-details-right .status-link { font-size: 15.2px; /* 0.95em = 15.2px */ }


        /* Responsive adjustments for Larger Text on MOBILE DEVICES */
        @media (max-width: 768px) {
            .larger-text h1 { font-size: 24px; /* 1.5em = 24px */ }
            .larger-text h2 { font-size: 20.8px; /* 1.3em = 20.8px */ }

            .larger-text .data-section,
            .larger-text #wallet-info {
                padding: 10px;
            }
            .larger-text #wallet-info p,
            .larger-text .data-item { font-size: 15.2px; /* 0.95em = 15.2px */ }
            .larger-text #account-address { font-size: 14.4px; /* 0.9em = 14.4px */ }
            .larger-text .button-group button { font-size: 16px; /* 1em = 16px */ }


            .larger-text .jetton-item {
                font-size: 13.6px; /* 0.85em = 13.6px */
                padding: 10px;
            }
            .larger-text .jetton-item img {
                width: 30px;
                height: 30px;
            }
            .larger-text .jetton-info-left .jetton-name,
            .larger-text .jetton-info-right .jetton-balance-amount { font-size: 16px; /* 1em = 16px */ }
            .larger-text .jetton-info-left .jetton-price,
            .larger-text .jetton-info-right .jetton-value-usd { font-size: 12.8px; /* 0.8em = 12.8px */ }

            .larger-text .event-item {
                font-size: 13.6px; /* 0.85em = 13.6px */
                padding: 10px;
            }
            .larger-text .event-item .event-token-image {
                width: 30px;
                height: 30px;
            }
            .larger-text .event-details-left .type-transaction,
            .larger-text .event-details-right .amount { font-size: 16px; /* 1em = 16px */ }
            .larger-text .event-details-left .from-to-addresses,
            .larger-text .event-details-left .comment-text,
            .larger-text .event-details-right .timestamp,
            .larger-text .event-details-right .status-link { font-size: 12.8px; /* 0.8em = 12.8px */ }
        }

        @media (max-width: 420px) {
            .larger-text .jetton-item {
                font-size: 12px; /* 0.75em = 12px */
                padding: 6px;
            }
            .larger-text .jetton-item img { width: 25px; height: 25px; }
            .larger-text .jetton-info-left .jetton-name,
            .larger-text .jetton-info-right .jetton-balance-amount { font-size: 14.4px; /* 0.9em = 14.4px */ }
            .larger-text .jetton-info-left .jetton-price,
            .larger-text .jetton-info-right .jetton-value-usd { font-size: 11.2px; /* 0.7em = 11.2px */ }

            .larger-text .event-item {
                font-size: 12px; /* 0.75em = 12px */
                padding: 6px;
            }
            .larger-text .event-item .event-token-image { width: 25px; height: 25px; }
            .larger-text .event-details-left .type-transaction,
            .larger-text .event-details-right .amount { font-size: 14.4px; /* 0.9em = 14.4px */ }
            .larger-text .event-details-left .from-to-addresses,
            .larger-text .event-details-left .comment-text,
            .larger-text .larger-text .event-details-right .timestamp,
            .larger-text .larger-text .event-details-right .status-link { font-size: 11.2px; /* 0.7em = 11.2px */ }
        }



















    </style>
</head>
<body>
    <div class="container">
        <h1>TON Wallet Information Dashboard</h1>
        <div id="connect-wallet"></div>
        <button id="disconnect-wallet" style="display:none;">Disconnect Wallet</button>

        <div id="wallet-info" style="display:none;">
            <p><strong>Connected Account:</strong> <span id="account-address"></span></p>
            <button id="fetch-data-btn">Fetch Account Data</button>
        </div>

        <div id="account-data" class="data-section" style="display:none;">
            <h2>I: Th√¥ng tin v√≠</h2>
            <div id="account-details-output"></div>
        </div>

        <div id="address-parse-data" class="data-section" style="display:none;">
            <h2>Parsed Address (Hidden)</h2>
            <div id="address-parse-output"></div>
        </div>

        <div id="jettons-data" class="data-section" style="display:none;">
            <h2>II: Jetton</h2>
            <div id="jettons-output"></div>
        </div>

        <div id="events-data" class="data-section" style="display:none;">
            <h2>III: L·ªãch s·ª≠ giao d·ªãch</h2>
            <div id="events-output"></div>
        </div>
    </div>
<script>
// Global Constants
const APP_CONFIG = {
    MANIFEST_URL: "https://bmweb.site/tonconnect-manifest.json",
    API_BASE_URL: "https://tonapi.io/v2",
    QR_CODE_WIDTH: 300,
    COPY_MESSAGE_DURATION: 2000,
    SWAL_TOAST_DURATION: 3000,
    JETTON_DEFAULT_DECIMALS: 9,
    API_RETRY_COUNT: 3,
    API_RETRY_DELAY_MS: 2000,
    EVENTS_PER_PAGE: 50 // S·ªë l∆∞·ª£ng s·ª± ki·ªán m·ªói l·∫ßn t·∫£i
};

// Initialize TonConnectUI
const connector = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: APP_CONFIG.MANIFEST_URL,
    buttonRootId: "connect-wallet"
});

// Get DOM elements
const walletInfoDiv = document.getElementById('wallet-info');
const accountAddressSpan = document.getElementById('account-address');
const disconnectButton = document.getElementById('disconnect-wallet');
const fetchDataButton = document.getElementById('fetch-data-btn');

const accountDataDiv = document.getElementById('account-data');
const accountDetailsOutput = document.getElementById('account-details-output');

const addressParseDataDiv = document.getElementById('address-parse-data'); // V·∫´n gi·ªØ l·∫°i nh∆∞ng ·∫©n
const addressParseOutput = document.getElementById('address-parse-output'); // V·∫´n gi·ªØ l·∫°i nh∆∞ng ·∫©n

const eventsDataDiv = document.getElementById('events-data');
const eventsOutput = document.getElementById('events-output');
const loadMoreEventsButton = document.getElementById('load-more-events-btn'); // N√∫t t·∫£i th√™m

const jettonsDataDiv = document.getElementById('jettons-data');
const jettonsOutput = document.getElementById('jettons-output');

let currentWalletAddress = null;
let lastEventLt = null; // Bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ LT c·ªßa s·ª± ki·ªán cu·ªëi c√πng ƒë√£ t·∫£i
let isLoadingEvents = false; // Tr·∫°ng th√°i t·∫£i s·ª± ki·ªán ƒë·ªÉ tr√°nh t·∫£i tr√πng l·∫∑p

// --- Utility Functions ---

// Function to show a SweetAlert2 toast
function showToast(icon, title) {
    Swal.fire({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: APP_CONFIG.SWAL_TOAST_DURATION,
        timerProgressBar: true,
        icon: icon,
        title: title
    });
}

// H√†m ƒë·ªãnh d·∫°ng s·ªë b·ªè s·ªë 0 cu·ªëi v√† th√™m d·∫•u ph√¢n c√°ch h√†ng ngh√¨n
function formatNumberWithoutTrailingZeros(num, minDecimals = 0, maxDecimals = 9) {
    if (typeof num !== 'number' || isNaN(num) || num === null) {
        return 'N/A';
    }
    // S·ª≠ d·ª•ng toLocaleString ƒë·ªÉ th√™m d·∫•u ch·∫•m ph√¢n c√°ch h√†ng ngh√¨n
    // v√† ki·ªÉm so√°t s·ªë l∆∞·ª£ng ch·ªØ s·ªë th·∫≠p ph√¢n.
    // D√πng 'en-US' locale ƒë·ªÉ c√≥ d·∫•u ph·∫©y l√† ph√¢n c√°ch h√†ng ngh√¨n.
    const formatted = num.toLocaleString('en-US', {
        minimumFractionDigits: minDecimals,
        maximumFractionDigits: maxDecimals
    });

    // Lo·∫°i b·ªè c√°c s·ªë 0 th·ª´a ·ªü cu·ªëi n·∫øu c√≥, v√† c·∫£ d·∫•u th·∫≠p ph√¢n n·∫øu s·ªë tr·ªü th√†nh s·ªë nguy√™n
    // V√≠ d·ª•: 1,250.00 -> 1,250; 0.25000 -> 0.25
    return formatted.replace(/(\.0+)$|(\.(\d*?[1-9])0+)$/, '.$2');
}

// Function to format balance from nanoTONs to TON
function formatTON(nanoTonAmount, maxDecimals = 5) {
    if (nanoTonAmount === undefined || nanoTonAmount === null) {
        return 'N/A';
    }
    const tonAmount = Number(nanoTonAmount) / 10**9;
    return formatNumberWithoutTrailingZeros(tonAmount, 0, maxDecimals) + ' TON';
}

// Function to format Jetton balance
function formatJettonBalance(balance, decimals) {
    if (balance === undefined || balance === null) {
        return 'N/A';
    }
    const divisor = 10**decimals;
    const jettonAmount = Number(balance) / divisor;
    // Gi·ªõi h·∫°n s·ªë th·∫≠p ph√¢n t·ªëi ƒëa cho hi·ªÉn th·ªã, sau ƒë√≥ b·ªè s·ªë 0 th·ª´a
    return formatNumberWithoutTrailingZeros(jettonAmount, 0, Math.min(decimals, 9)); // maxDecimals c√≥ th·ªÉ l√™n ƒë·∫øn 9
}

// --- TonConnect Event Listeners ---

// Listen for wallet connection status changes
connector.onStatusChange(async wallet => {
    if (wallet) {
        try {
            const parsedAddress = await fetchDataWithRetry(`${APP_CONFIG.API_BASE_URL}/address/${wallet.account.address}/parse`);
            currentWalletAddress = parsedAddress.non_bounceable.b64url;
        } catch (error) {
            console.error("Error parsing address on connect:", error);
            currentWalletAddress = wallet.account.address; // Fallback if parsing fails
        }

        accountAddressSpan.textContent = currentWalletAddress;
        walletInfoDiv.style.display = 'block';
        disconnectButton.style.display = 'block';
        showToast('success', 'Wallet Connected!');
        // Reset lastEventLt v√† t·∫£i d·ªØ li·ªáu m·ªõi khi k·∫øt n·ªëi v√≠
        lastEventLt = null;
        fetchAccountData(currentWalletAddress, true); // true ƒë·ªÉ t·∫£i l·∫°i to√†n b·ªô s·ª± ki·ªán m·ªõi
    } else {
        currentWalletAddress = null;
        walletInfoDiv.style.display = 'none';
        disconnectButton.style.display = 'none';
        accountDataDiv.style.display = 'none';
        addressParseDataDiv.style.display = 'none';
        eventsDataDiv.style.display = 'none';
        jettonsDataDiv.style.display = 'none';
        loadMoreEventsButton.style.display = 'none'; // ·∫®n n√∫t t·∫£i th√™m
        eventsOutput.innerHTML = ''; // X√≥a s·ª± ki·ªán c≈©
        showToast('info', 'Wallet Disconnected!');
    }
});

// Disconnect button functionality
disconnectButton.addEventListener('click', () => {
    connector.disconnect();
});

// Fetch Data Button (ƒë·ªÉ t·∫£i l·∫°i to√†n b·ªô d·ªØ li·ªáu, bao g·ªìm s·ª± ki·ªán t·ª´ ƒë·∫ßu)
fetchDataButton.addEventListener('click', () => {
    if (currentWalletAddress) {
        lastEventLt = null; // ƒê·∫∑t l·∫°i LT ƒë·ªÉ t·∫£i t·ª´ ƒë·∫ßu
        fetchAccountData(currentWalletAddress, true); // true ƒë·ªÉ t·∫£i l·∫°i to√†n b·ªô
    } else {
        showToast('error', 'No wallet connected!');
    }
});

// Load More Events Button functionality
// Ch·ªâ th√™m event listener n√†y n·∫øu n√∫t loadMoreEventsButton t·ªìn t·∫°i
if (loadMoreEventsButton) {
    loadMoreEventsButton.addEventListener('click', () => {
        if (currentWalletAddress && lastEventLt && !isLoadingEvents) {
            fetchAccountEvents(currentWalletAddress, lastEventLt, false); // false ƒë·ªÉ ch·ªâ n·ªëi th√™m, kh√¥ng ghi ƒë√®
        } else if (isLoadingEvents) {
            showToast('info', 'ƒêang t·∫£i th√™m giao d·ªãch...');
        } else {
            showToast('info', 'Kh√¥ng c√≥ th√™m giao d·ªãch n√†o ƒë·ªÉ t·∫£i.');
        }
    });
}


// --- Data Fetching Functions ---

async function fetchDataWithRetry(url) {
    for (let i = 0; i < APP_CONFIG.API_RETRY_COUNT; i++) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                // N·∫øu l√† l·ªói 404 ho·∫∑c 400 v√† kh√¥ng ph·∫£i l·∫ßn th·ª≠ cu·ªëi, th√¨ b·ªè qua v√† th·ª≠ l·∫°i
                if ((response.status === 404 || response.status === 400) && i < APP_CONFIG.API_RETRY_COUNT - 1) {
                    console.warn(`HTTP error ${response.status} for ${url}. Retrying...`);
                    await new Promise(resolve => setTimeout(resolve, APP_CONFIG.API_RETRY_DELAY_MS));
                    continue; // Ti·∫øp t·ª•c v√≤ng l·∫∑p ƒë·ªÉ th·ª≠ l·∫°i
                }
                throw new Error(`HTTP error! status: ${response.status} - ${await response.text()}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Attempt ${i + 1} failed for ${url}:`, error);
            if (i < APP_CONFIG.API_RETRY_COUNT - 1) {
                await new Promise(resolve => setTimeout(resolve, APP_CONFIG.API_RETRY_DELAY_MS));
            } else {
                throw error; // Re-throw error if all retries fail
            }
        }
    }
}


// H√†m ch√≠nh ƒë·ªÉ t·∫£i t·∫•t c·∫£ d·ªØ li·ªáu
async function fetchAccountData(address, reloadAll = false) {
    if (!address) return;

    // Clear previous data and show loading states
    accountDetailsOutput.innerHTML = '<p>Loading account details...</p>';
    jettonsOutput.innerHTML = '<p>Loading jettons...</p>';
    
    // Ensure data sections are visible
    accountDataDiv.style.display = 'block';
    jettonsDataDiv.style.display = 'block';
    eventsDataDiv.style.display = 'block';
    if (loadMoreEventsButton) {
        loadMoreEventsButton.style.display = 'none'; // ·∫®n n√∫t t·∫£i th√™m ban ƒë·∫ßu
    }

    try {
        // 1. Fetch Account Details (unchanged)
        const accountDetails = await fetchDataWithRetry(`${APP_CONFIG.API_BASE_URL}/accounts/${address}`);
        accountDetailsOutput.innerHTML = `
            <div class="data-item"><strong>ƒê·ªãa ch·ªâ v√≠:</strong> <span>${accountDetails.address}</span></div>
            <div class="data-item"><strong>Balance:</strong> <span>${formatTON(accountDetails.balance)}</span></div>
            <div class="data-item"><strong>Status:</strong> <span>${accountDetails.status === 'active' ? 'Active' : 'Inactive'}</span></div>
        `;
    } catch (error) {
        accountDetailsOutput.innerHTML = `<div class="error-message">Error fetching account details: ${error.message}</div>`;
    }

    try {
        // 2. Fetch Jetton Balances (unchanged - ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh trong formatJettonBalance)
        const jettons = await fetchDataWithRetry(`${APP_CONFIG.API_BASE_URL}/accounts/${address}/jettons?currencies=usdt`);
        if (jettons.balances && jettons.balances.length > 0) {
            jettonsOutput.innerHTML = jettons.balances.map(jettonBalance => {
                const jettonDecimals = jettonBalance.jetton?.decimals || APP_CONFIG.JETTON_DEFAULT_DECIMALS;
                const formattedBalance = formatJettonBalance(jettonBalance.balance, jettonDecimals);
                const priceUSDT = jettonBalance.price?.prices?.USDT;
                
                // ƒê·ªÉ t√≠nh to√°n gi√° tr·ªã USDT, c·∫ßn chuy·ªÉn ƒë·ªïi formattedBalance v·ªÅ d·∫°ng s·ªë
                // X√≥a b·ªè d·∫•u ph√¢n c√°ch h√†ng ngh√¨n (',' trong 'en-US' locale)
                const numericBalance = parseFloat(formattedBalance.replace(/,/g, ''));
                const valueUSDT = priceUSDT ? formatNumberWithoutTrailingZeros(numericBalance * priceUSDT, 2, 2) : 'N/A';
                
                const diff24h = jettonBalance.price?.diff_24h?.USDT;
                const diff24hText = diff24h ? `${(diff24h * 100).toFixed(2)}%` : 'N/A';

                return `
                    <div class="jetton-item">
                        <img src="${jettonBalance.jetton?.image || 'https://via.placeholder.com/40?text=' + (jettonBalance.jetton?.symbol || 'JTN')}" alt="${jettonBalance.jetton?.symbol || 'Jetton'} logo">
                        <div class="jetton-info-left">
                            <span class="jetton-name">${jettonBalance.jetton?.name || 'Unknown'} (${jettonBalance.jetton?.symbol || 'JTN'})</span>
                            <span class="jetton-price">Gi√°: $${priceUSDT ? formatNumberWithoutTrailingZeros(priceUSDT, 2, 5) : '0'} (${diff24hText})</span>
                        </div>
                        <div class="jetton-info-right">
                            <span class="jetton-balance-amount">${formattedBalance} ${jettonBalance.jetton?.symbol || 'JTN'}</span>
                            <span class="jetton-value-usd">Gi√° tr·ªã: $${valueUSDT}</span>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            jettonsOutput.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y Jetton n√†o.</p>';
        }
    } catch (error) {
        jettonsOutput.innerHTML = `<div class="error-message">Error fetching Jettons: ${error.message}</div>`;
    }

    // T·∫£i s·ª± ki·ªán (lu√¥n g·ªçi, v√† x·ª≠ l√Ω ph√¢n trang b√™n trong)
    if (reloadAll) {
        eventsOutput.innerHTML = '<p>ƒêang t·∫£i l·ªãch s·ª≠ giao d·ªãch...</p>'; // Th√¥ng b√°o t·∫£i
        lastEventLt = null; // ƒê·∫∑t l·∫°i ƒë·ªÉ t·∫£i t·ª´ ƒë·∫ßu
    }
    await fetchAccountEvents(address, lastEventLt, reloadAll);
}


// H√†m m·ªõi ƒë·ªÉ t·∫£i s·ª± ki·ªán c√≥ ph√¢n trang
async function fetchAccountEvents(address, beforeLt = null, clearExisting = false) {
    if (isLoadingEvents) return;
    isLoadingEvents = true;
    if (loadMoreEventsButton) {
        loadMoreEventsButton.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t khi ƒëang t·∫£i
        loadMoreEventsButton.textContent = 'ƒêang t·∫£i...';
    }

    let url = `${APP_CONFIG.API_BASE_URL}/accounts/${address}/events?initiator=false&subject_only=false&limit=${APP_CONFIG.EVENTS_PER_PAGE}`;
    if (beforeLt) {
        url += `&before_lt=${beforeLt}`;
    }

    try {
        const eventsResponse = await fetchDataWithRetry(url);
        const newEvents = eventsResponse.events || [];

        if (clearExisting) {
            eventsOutput.innerHTML = ''; // X√≥a c√°c s·ª± ki·ªán c≈© n·∫øu l√† t·∫£i l·∫°i to√†n b·ªô
        } else if (eventsOutput.innerHTML === '<p>ƒêang t·∫£i l·ªãch s·ª≠ giao d·ªãch...</p>' || eventsOutput.innerHTML === '<p>Kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ giao d·ªãch g·∫ßn ƒë√¢y.</p>') {
            eventsOutput.innerHTML = ''; // X√≥a th√¥ng b√°o t·∫£i ban ƒë·∫ßu
        }


        if (newEvents.length > 0) {
            const eventsHtml = newEvents.map(event => {
                const action = event.actions[0];
                let tokenImage = 'https://via.placeholder.com/40'; // Placeholder m·∫∑c ƒë·ªãnh
                let type = action?.type || 'Unknown';
                let senderAddress = 'N/A';
                let recipientAddress = 'N/A';
                let comment = 'No Memo/Comment';
                let amountValue = ''; // Gi√° tr·ªã s·ªë l∆∞·ª£ng th√¥ ƒë√£ ƒë·ªãnh d·∫°ng
                let unit = ''; // ƒê∆°n v·ªã (TON, Jetton symbol, NFT)
                let eventClass = ''; // 'sent' or 'received' or 'swap' for styling
                let statusText = 'Completed';
                const timestamp = new Date(event.timestamp * 1000).toLocaleString('vi-VN', {hour: '2-digit', minute:'2-digit', day: '2-digit', month: '2-digit', year: 'numeric'});
                const transactionHash = event.event_id;
                const linkToTonviewer = `https://tonviewer.com/event/${transactionHash}`;

                // --- Logic x·ª≠ l√Ω t·ª´ng lo·∫°i giao d·ªãch ---
                if (action) {
                    if (action.type === 'TonTransfer' && action.TonTransfer) {
                        senderAddress = action.TonTransfer.sender?.address || 'Unknown';
                        recipientAddress = action.TonTransfer.recipient?.address || 'Unknown';
                        const tonAmount = Number(action.TonTransfer.amount) / 1e9;
                        amountValue = formatNumberWithoutTrailingZeros(tonAmount, 0, 5); // Format TON
                        unit = 'TON';
                        comment = action.TonTransfer.comment || comment;
                        tokenImage = '/logo-coin/ton.jpg'; 
                        eventClass = (senderAddress.toLowerCase() === currentWalletAddress.toLowerCase()) ? 'sent' : 'received';

                    } else if (action.type === 'JettonTransfer' && action.JettonTransfer) {
                        senderAddress = action.JettonTransfer.sender?.address || 'Unknown';
                        recipientAddress = action.JettonTransfer.recipient?.address || 'Unknown';
                        // S·ª≠ d·ª•ng action.JettonTransfer.jetton ƒë·ªÉ l·∫•y th√¥ng tin Jetton
                        const jettonDecimals = action.JettonTransfer.jetton?.decimals || APP_CONFIG.JETTON_DEFAULT_DECIMALS;
                        const jettonAmount = Number(action.JettonTransfer.amount) / (10**jettonDecimals);
                        amountValue = formatNumberWithoutTrailingZeros(jettonAmount, 0, Math.min(jettonDecimals, 9)); // Format Jetton
                        unit = action.JettonTransfer.jetton?.symbol || 'Jetton';
                        
                        tokenImage = action.JettonTransfer.jetton?.image 
                                   || action.simple_preview?.value_image 
                                   || 'https://via.placeholder.com/40';

                        comment = action.JettonTransfer.comment || comment;
                        eventClass = (senderAddress.toLowerCase() === currentWalletAddress.toLowerCase()) ? 'sent' : 'received';

                    } else if (action.type === 'JettonSwap' && action.JettonSwap) {
                        type = 'Jetton Swap';
                        const swap = action.JettonSwap;
                        senderAddress = swap.user_wallet?.address || 'Unknown';
                        recipientAddress = swap.router?.address || 'Unknown';

                        let amountInFormatted = '';
                        let symbolIn = '';
                        let imageIn = '';

                        if (swap.jetton_master_in) {
                            const decimalsIn = swap.jetton_master_in.decimals || APP_CONFIG.JETTON_DEFAULT_DECIMALS;
                            amountInFormatted = formatNumberWithoutTrailingZeros(Number(swap.amount_in) / (10**decimalsIn), 0, Math.min(decimalsIn, 9));
                            symbolIn = swap.jetton_master_in.symbol || 'JTN';
                            imageIn = swap.jetton_master_in.image || 'https://via.placeholder.com/40';
                        } else if (swap.ton_in) {
                            amountInFormatted = formatNumberWithoutTrailingZeros(Number(swap.ton_in) / 1e9, 0, 5);
                            symbolIn = 'TON';
                            imageIn = '/logo-coin/ton.jpg';
                        }

                        let amountOutFormatted = '';
                        let symbolOut = '';
                        let imageOut = '';

                        if (swap.jetton_master_out) {
                            const decimalsOut = swap.jetton_master_out.decimals || APP_CONFIG.JETTON_DEFAULT_DECIMALS;
                            amountOutFormatted = formatNumberWithoutTrailingZeros(Number(swap.amount_out) / (10**decimalsOut), 0, Math.min(decimalsOut, 9));
                            symbolOut = swap.jetton_master_out.symbol || 'JTN';
                            imageOut = swap.jetton_master_out.image || 'https://via.placeholder.com/40';
                        } else if (swap.ton_out) {
                            amountOutFormatted = formatNumberWithoutTrailingZeros(Number(swap.ton_out) / 1e9, 0, 5);
                            symbolOut = 'TON';
                            imageOut = '/logo-coin/ton.jpg';
                        }
                        
                        tokenImage = imageOut; // L·∫•y ·∫£nh c·ªßa token nh·∫≠n ƒë∆∞·ª£c
                        
                        // ƒê·ªëi v·ªõi Swap, amountDisplay s·∫Ω kh√°c bi·ªát, kh√¥ng c√≥ d·∫•u +/- ·ªü ƒë·∫ßu
                        const amountDisplayHtml = `
                            <span class="amount-swap">
                                <img src="${imageIn}" alt="${symbolIn}" class="swap-token-image"> ${amountInFormatted} ${symbolIn}
                                <span class="swap-arrow">üîÅ</span>
                                <img src="${imageOut}" alt="${symbolOut}" class="swap-token-image"> ${amountOutFormatted} ${symbolOut}
                            </span>
                        `;
                        comment = `Swap via ${swap.dex || 'Unknown DEX'}`;
                        eventClass = 'swap'; // Th√™m class 'swap' cho styling ƒë·∫∑c bi·ªát n·∫øu c·∫ßn

                        // Tr·∫£ v·ªÅ HTML cho swap ngay l·∫≠p t·ª©c v√¨ amountDisplay ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a c·ª•c b·ªô
                        return generateEventHtml(tokenImage, type, senderAddress, recipientAddress, comment, amountDisplayHtml, eventClass, timestamp, transactionHash, linkToTonviewer, statusText);

                    } else if (action.type === 'NftItemTransfer' && action.NftItemTransfer) {
                        type = 'NFT Transfer';
                        senderAddress = action.NftItemTransfer.sender?.address || 'Unknown';
                        recipientAddress = action.NftItemTransfer.recipient?.address || 'Unknown';
                        amountValue = '1'; // NFT lu√¥n l√† 1 ƒë∆°n v·ªã
                        unit = 'NFT';
                        comment = action.NftItemTransfer.nft_info?.name || comment;
                        tokenImage = action.NftItemTransfer.nft_info?.image || tokenImage;
                        eventClass = (senderAddress.toLowerCase() === currentWalletAddress.toLowerCase()) ? 'sent' : 'received';
                    }
                    // Add other action types as needed (Liquid staking, etc.)
                    else {
                        type = action.simple_preview?.name || type;
                        comment = action.simple_preview?.description || comment;
                        const previewImage = action.simple_preview?.items?.find(item => item.image)?.image;
                        tokenImage = previewImage || 'https://via.placeholder.com/40';
                        // C·ªë g·∫Øng ƒë·ªãnh d·∫°ng amountValue t·ª´ simple_preview n·∫øu n√≥ l√† s·ªë
                        if (action.simple_preview?.value && !isNaN(parseFloat(action.simple_preview.value))) {
                            // L·∫•y s·ªë t·ª´ chu·ªói simple_preview.value, c√≥ th·ªÉ c√≥ c·∫£ ƒë∆°n v·ªã
                            const numericPart = parseFloat(action.simple_preview.value);
                            const unitPart = action.simple_preview.value.replace(numericPart, '').trim();
                            amountValue = formatNumberWithoutTrailingZeros(numericPart, 0, 5);
                            unit = unitPart || '';
                        } else {
                            amountValue = action.simple_preview?.value || '';
                            unit = '';
                        }
                        
                        eventClass = ''; // M·∫∑c ƒë·ªãnh kh√¥ng c√≥ class sent/received n·∫øu kh√¥ng r√µ r√†ng

                        // C·ªë g·∫Øng x√°c ƒë·ªãnh eventClass d·ª±a tr√™n accounts trong simple_preview n·∫øu c√≥ th·ªÉ
                        if (action.simple_preview?.accounts && action.simple_preview.accounts.length > 0) {
                            const isSender = action.simple_preview.accounts.some(acc => acc.address.toLowerCase() === currentWalletAddress.toLowerCase() && acc.is_sender);
                            const isRecipient = action.simple_preview.accounts.some(acc => acc.address.toLowerCase() === currentWalletAddress.toLowerCase() && acc.is_recipient);

                            if (isSender && !isRecipient) {
                                eventClass = 'sent';
                            } else if (isRecipient && !isSender) {
                                eventClass = 'received';
                            } else if (isSender && isRecipient) {
                                eventClass = 'internal'; // C√≥ th·ªÉ th√™m class m·ªõi cho lo·∫°i n√†y
                            }
                        }
                    }
                }

                // √Åp d·ª•ng d·∫•u +/- v√† m√†u s·∫Øc cho c√°c giao d·ªãch g·ª≠i/nh·∫≠n
                // Ch·ªâ √°p d·ª•ng n·∫øu kh√¥ng ph·∫£i l√† JettonSwap (ƒë√£ x·ª≠ l√Ω ri√™ng)
                let finalAmountDisplay = '';
                if (eventClass === 'sent') {
                    finalAmountDisplay = `- ${amountValue} ${unit}`;
                } else if (eventClass === 'received') {
                    finalAmountDisplay = `+ ${amountValue} ${unit}`;
                } else {
                    finalAmountDisplay = amountValue ? `${amountValue} ${unit}` : 'N/A'; // Fallback n·∫øu kh√¥ng ph·∫£i g·ª≠i/nh·∫≠n/swap
                }

                return generateEventHtml(tokenImage, type, senderAddress, recipientAddress, comment, finalAmountDisplay, eventClass, timestamp, transactionHash, linkToTonviewer, statusText);
            }).join('');
            
            eventsOutput.insertAdjacentHTML('beforeend', eventsHtml); // N·ªëi th√™m c√°c s·ª± ki·ªán m·ªõi
            
            // C·∫≠p nh·∫≠t lastEventLt ch·ªâ n·∫øu c√≥ s·ª± ki·ªán m·ªõi ƒë∆∞·ª£c t·∫£i
            if (newEvents.length > 0) {
                lastEventLt = newEvents[newEvents.length - 1].lt;
            }

            if (newEvents.length === APP_CONFIG.EVENTS_PER_PAGE && loadMoreEventsButton) {
                loadMoreEventsButton.style.display = 'block'; // Hi·ªÉn th·ªã n√∫t n·∫øu c√≥ kh·∫£ nƒÉng c√≤n trang
                loadMoreEventsButton.textContent = 'T·∫£i th√™m giao d·ªãch';
            } else if (loadMoreEventsButton) {
                loadMoreEventsButton.style.display = 'none'; // ·∫®n n√∫t n·∫øu ƒë√£ h·∫øt s·ª± ki·ªán
                showToast('info', 'ƒê√£ t·∫£i to√†n b·ªô l·ªãch s·ª≠ giao d·ªãch.');
            }
        } else {
            // N·∫øu kh√¥ng c√≥ s·ª± ki·ªán m·ªõi ƒë∆∞·ª£c t·∫£i
            if (clearExisting && eventsOutput.innerHTML.includes('ƒêang t·∫£i')) { // N·∫øu l√† l·∫ßn t·∫£i ƒë·∫ßu ti√™n v√† kh√¥ng c√≥ s·ª± ki·ªán
                eventsOutput.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ giao d·ªãch g·∫ßn ƒë√¢y.</p>';
            }
            if (loadMoreEventsButton) {
                loadMoreEventsButton.style.display = 'none'; // ·∫®n n√∫t n·∫øu kh√¥ng c√≥ th√™m
            }
            if (!clearExisting) { // Ch·ªâ hi·ªÉn th·ªã toast n·∫øu kh√¥ng ph·∫£i l·∫ßn t·∫£i ƒë·∫ßu ti√™n
                showToast('info', 'Kh√¥ng c√≥ th√™m giao d·ªãch n√†o.');
            }
        }
    } catch (error) {
        console.error("Error fetching events:", error);
        if (clearExisting) {
            eventsOutput.innerHTML = `<div class="error-message">Error fetching events: ${error.message}</div>`;
        } else {
            showToast('error', `L·ªói khi t·∫£i giao d·ªãch: ${error.message}`);
        }
        if (loadMoreEventsButton) {
            loadMoreEventsButton.style.display = 'none';
        }
    } finally {
        isLoadingEvents = false;
        if (loadMoreEventsButton) {
            loadMoreEventsButton.disabled = false; // B·∫≠t l·∫°i n√∫t
            loadMoreEventsButton.textContent = 'T·∫£i th√™m giao d·ªãch'; // ƒê·∫∑t l·∫°i text
        }
    }
}

// H√†m tr·ª£ gi√∫p ƒë·ªÉ t·∫°o HTML cho m·ªôt s·ª± ki·ªán (gi√∫p code r√µ r√†ng h∆°n)
function generateEventHtml(tokenImage, type, senderAddress, recipientAddress, comment, amountDisplay, eventClass, timestamp, transactionHash, linkToTonviewer, statusText) {
    const shortenAddress = (addr) => addr !== 'Unknown' ? `${addr.slice(0, 4)}...${addr.slice(-4)}` : 'Unknown';
    const displayedComment = comment.length > 30 ? comment.slice(0, 30) + '...' : comment;

    return `
        <div class="event-item ${eventClass}">
            <img src="${tokenImage}" alt="Token" class="event-token-image">
            <div class="event-details-left">
                <span class="type-transaction"><strong></strong> ${type}</span>
                <span class="from-to-addresses"><strong>From:</strong> ${shortenAddress(senderAddress)} <br> <strong>To:</strong> ${shortenAddress(recipientAddress)}</span>
                <span class="comment-text"><strong>Comment:</strong> ${displayedComment}</span>
            </div>
            <div class="event-details-right">
                <span class="amount">${amountDisplay}</span>
                <span class="timestamp">${timestamp}</span>
                <a href="${linkToTonviewer}" target="_blank" class="status-link">${statusText} üîó</a>
            </div>
        </div>
    `;
}
</script>
</body>
</html>
